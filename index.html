<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <style>
body {
  background-color: #666;
}
.bar {
  fill: #1f78b4;
}

.bar:hover {
  fill: #a6cee3;
}

.bar.positive {
  fill: #33a02c;
}

.bar.positive:hover {
  fill: #b2df8a;
}

.bar.negative {
  fill: #e31a1c;
}

.bar.negative:hover {
  fill: #fb9a99;
}

.title {
  font: bold 14px "Helvetica Neue", Helvetica, Arial, sans-serif;
}

.axis {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

div.block {
  padding: 1em;
}
</style>
  </head>
  <body>
    <h1>Hello</h1>

    <script src="d3.js" type="text/javascript"></script>
    <script src="wrap.js" type="text/javascript"></script>
    <script src="waterfallChart.js" type="text/javascript"></script>
    <script src="meanChart.js" type="text/javascript"></script>
    <script type="text/javascript">

var margin = {top: 80, right: 90, bottom: 80, left: 90},
    width = 680 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;


var act = 1600;
var rawWaterfall = [
  { name: 'Montant forfaitaire', value: 990 },
  { name: 'Bonification', value: 160 },
  { name: '61% des revenus d’activité', value: 0.61*act },
  { name: 'Forfait logement', value: 70 },
  { name: 'Revenus d’activité', value: act },
  { name: 'Revenus hors activité', value: 10 },
];

var rawMean = [
  { name: 'Prime d’activité fictive pour Décembre 2018', value: 300 },
  { name: 'Prime d’activité fictive pour Janvier 2019', value: 100 },
  { name: 'Prime d’activité fictive pour Février 2019', value: 200 },
  { name: '', value: 0 },
  { name: 'Prime d’activité pour Mars 2019', value: 200 },
];

var step = 1;
var values = [rawWaterfall, rawMean];
/*

var meanC = meanChart(d3.select("body"), {
  height: height,
  margin: margin,
  width: width,
});

var waterfallC = waterfallChart(d3.select("body"), {
  height: height,
  margin: margin,
  width: width,
});
/*
waterfallC.refresh(rawWaterfall);
waterfallC.title("Votre prime d'activité fictive de Février 2019");
meanC.refresh(rawMean);
meanC.title("Votre prime d'activité de Mars 2019");
//*/

</script>

    <pre>
    - OK
      - détails 3 mois
    - KO
      - KO test pour étudiant
        - mois KO
      - OK test pour étudiant
        - 0 < moyenne < minimum
        - détails 3 mois
    </pre>
<script type="text/javascript">

var round = function(v) {
  return Math.round(v * 100 ) / 100
}

var logic = {
  name: "OK",
  condition: function(d) { return this("ppa", d.M); },
  if: {
    text: function(d) {
      var montant = round(this("ppa", d.M));
      return `Selon notre simulateur, en ${d.labels.M}, vous pouvez bénéficier de la prime d'activité pour un montant de ${montant}&nbsp;€&nbsp;/&nbsp;mois.`;
    },
    next: {
      name: "Détail 3 mois",
      intro: "La prime d'activité est calculée en faisant la moyenne de 3 valeurs appelées primes d'activité fictives. Il y a une prime d'activité fictive par mois du trimestre de référence.",
      condition: function(d) {
        var mois = ['Mm1', 'Mm2', 'Mm3'];
        var first = this("ppa_fictive", d[mois[0]]);
        return mois.map(m => this("ppa_fictive", d[m])).reduce((a, v) => a && v == first, true);
      },
      if: {
        text: function(d) {
          return `Vos primes d'activité fictives valent ${round(this("ppa_fictive", d.Mm1))}&nbsp;€ sur chacun des mois du trimestre de référence.`;
        }
      },
      else: {
        text: function(d) {
          return `Vos primes d'activité fictives valent&nbsp;:<br>\
          - ${round(this("ppa_fictive", d.Mm3))}&nbsp;€ pour ${d.labels.Mm3},<br>\
          - ${round(this("ppa_fictive", d.Mm2))}&nbsp;€ pour ${d.labels.Mm2} et<br>\
          - ${round(this("ppa_fictive", d.Mm1))}&nbsp;€ pour ${d.labels.Mm1}.`;
        }
      }
    }
  },
  else: {
    text: "Selon notre simulateur, vous ne pouvez pas bénéficier de la prime d'activité.",
    next: {
      name: "KO",
      intro: "La prime d'activité est calculée en faisant la moyenne de 3 valeurs appelées primes d'activité fictives. Il y a une prime d'activité fictive par mois du trimestre de référence.",
      condition: function(d) { return ! this("ppa_eligibilite_etudiants", d.M); },
      if: {
        text: function(d) {
          var params = this.p("ppa_eligibilite_etudiants", d.M);
          var seuil = 169 *
            params("cotsoc.gen.smic_h_b", d.D) *
            params("prestations.prestations_familiales.af.seuil_rev_taux", d.D);
          var roundedSeuil = round(seuil);

          var mois = ['Mm1', 'Mm2', 'Mm3'];
          var moisSousSeuil = mois.filter(m => this('ppa_revenu_activite_individu', d[m])<seuil);

          return `En tant qu'étudiant.e, pour être éligible à la prime d'activité,\
          il faut aussi que pour chaque mois vos ressources d'activité soient supérieures à ${roundedSeuil}&nbsp;€ or\
          pour le${moisSousSeuil.length>1 ? 's' : ''} mois de ${moisSousSeuil.map(m=> d.labels[m]).join(' et ')},\
          vos ressources n'ont été que de ${moisSousSeuil.map(m => round(this('ppa_revenu_activite_individu', d[m])) + '&nbsp;€').join(' et ')} respectivement.`
        },
        //next: {}
      },
    },
  },
};

;
var tests = [];
function rec(obj) {
  tests.push(obj);
  if (obj.if && obj.if.next) {
    rec(obj.if.next);
  }
  if (obj.else && obj.else.next) {
    rec(obj.else.next);
  }
}
rec(logic);

d3.json('openfisca-trace.json').then(function(data) {
  var requested = data.requestedCalculations;
  var ppas = requested.filter(function(name) { return name.startsWith("ppa"); });
  ppas.sort();
  var ppaKey = ppas[ppas.length - 1];

  var todo = ppaKey
  var ppa = data.trace[ppaKey];

  var depths = {};
  depths[ppaKey] = 0;

  var result = Object.assign({}, ppa);
  var dates = {
    M: '2019-04',
    Mm1: '2019-03',
    Mm2: '2019-02',
    Mm3: '2019-01',
    D: '2019-04-01',
    labels: {
      M: 'avril 2019',
      Mm1: 'mars 2019',
      Mm2: 'février 2019',
      Mm3: 'janvier 2019',
    }
  }

  var root = document.body;

  var compo = function(name, period) {
    const key = `${name}<${period}>`;
    return data.trace[key].value[0];
  }

  compo.p = function(name, period) {
    const key = `${name}<${period}>`;
    const params = data.trace[key].parameters;

    function parameterGetter(name, period) {
      const pkey = `${name}<${period}>`;
      return params[pkey]
    }

    return parameterGetter;
  }

  var evl = function (block) {
    if (typeof block === 'function') {
      return block.apply(compo, [dates]);
    }
    return block;
  };

  var appendText = function(element, text) {
    var t = document.createElement('div');
    t.innerHTML = text;

    element.appendChild(t);
  }

  var compute = function (parent, block) {
    var node = document.createElement('div');
    node.classList.add('block');

    parent.appendChild(node);
    appendText(node, 'En savoir plus:');
    appendText(node, 'name: ' + block.name);
    if (block.intro) {
      appendText(node, 'intro: ' + block.intro);
    }
    var condition = evl(block.condition);
    appendText(node, 'condition: ' + condition);
    appendText(node, 'text if: ' + evl(block.if && block.if.text));
    if (block.if && block.if.next) {
      compute(node, block.if.next);
    }
    appendText(node, 'text else: ' + evl(block.else && block.else.text));
    if (block.else && block.else.next) {
      compute(node, block.else.next);
    }
  }

  compute(root, logic);
});

    </script>    
  </body>
</html>
